---
import Layout from '../layouts/Layout.astro';
import { supabase } from '@/lib/supabase';

// Get the current session
const { data: { session } } = await supabase.auth.getSession();

// Check if user is authenticated
if (!session?.user) {
  return Astro.redirect('/', 302);
}

const user = session.user;

// Get user details from our users table
const { data: userDetails } = await supabase
  .from('users')
  .select('*')
  .eq('id', user.id)
  .single();

const title = "My Profile - LowCal Kitchen";
const description = "Manage your LowCal Kitchen profile, preferences, and account settings.";
---

<Layout 
  title={title}
  description={description}
  type="profile"
>
  <div class="max-w-4xl mx-auto px-4 py-8">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8">
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-6">My Profile</h1>
      
      <div class="space-y-4">
        <div>
          <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">Account Information</h2>
          <p class="text-gray-600 dark:text-gray-300">Email: {user.email}</p>
          <p class="text-gray-600 dark:text-gray-300">Member Since: {new Date(userDetails?.created_at || '').toLocaleDateString()}</p>
          <p class="text-gray-600 dark:text-gray-300">Role: {userDetails?.role || 'user'}</p>
        </div>

        <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
          <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">Preferences</h2>
          <p class="text-gray-600 dark:text-gray-300">
            Manage your account preferences and settings here.
          </p>
        </div>

        <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
          <button
            id="signOutButton"
            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
          >
            Sign Out
          </button>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { supabase } from '@/lib/supabase';

  // Add event listener to sign out button
  document.getElementById('signOutButton')?.addEventListener('click', async () => {
    try {
      const { error } = await supabase.auth.signOut();
      if (error) throw error;
      window.location.href = '/';
    } catch (error) {
      console.error('Error signing out:', error);
    }
  });
</script>